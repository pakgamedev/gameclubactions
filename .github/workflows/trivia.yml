name: Daily Doodling Exercise

on:
  schedule:
    # Runs at 12:00 PM PKT (07:00 AM UTC) every Thursday
    - cron: '0 7 * * *'
  workflow_dispatch:

jobs:
  post-exercise:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install axios discord.js

      - name: Fetch Trivia and Post to Discord
        run: |
          node -e "
          const axios = require('axios');
          const { Client, GatewayIntentBits } = require('discord.js');

          async function run() {
            try {
              // 1. Fetch Trivia Question
              const triviaRes = await axios.get('https://opentdb.com/api.php?amount=1&type=boolean');
              const trivia = triviaRes.data.results[0];

              const question = trivia.question
                .replace(/&quot;/g, '\"')
                .replace(/&#039;/g, \`'\`)
                .replace(/&amp;/g, '&');
              const correctAnswer = trivia.correct_answer;

              // 2. Fetch Random Image from Unsplash
              let imageBuffer = null;
              async function fetchImage(query) {
                try {
                  const unsplashRes = await axios.get('https://api.unsplash.com/photos/random', {
                    params: { 
                      query: query, 
                      orientation: 'landscape',
                      content_filter: 'high'
                    },
                    headers: { 'Authorization': \`Client-ID \${{ secrets.UNSPLASH_ACCESS_KEY }}\` }
                  });
                  
                  const imageDownload = await axios.get(unsplashRes.data.urls.regular, {
                    responseType: 'arraybuffer'
                  });
                  return Buffer.from(imageDownload.data);
                } catch (e) {
                  return null;
                }
              }
              imageBuffer = await fetchImage('blank sketchbook');

              // 3. Setup Discord Bot
              const client = new Client({ intents: [GatewayIntentBits.Guilds] });
              await client.login('${{ secrets.DISCORD_BOT_TOKEN }}');

              client.once('ready', async () => {
                const channel = await client.channels.fetch('${{ secrets.DISCORD_FORUM_CHANNEL_ID }}');

                const title = \`Doodling Exercise | \${correctAnswer.toUpperCase()} Trivia\`;
                const content =
                  \`Today's Doodling Exercise Prompt:\\n\\n\` +
                  \`**\${question}**\\n\\n\` +
                  \`Do a quick and fun doodle inspired by this statement. Interpret it literally, metaphorically, or creatively.\\n\\n\` + 
                  \`That's it. Put your answers in the comments below!\\n\\n---\\nCheck https://discord.com/channels/1263723973603102802/1469711211158310992 for details!\`;

                const messagePayload = {
                  content: content
                };

                if (imageBuffer) {
                  messagePayload.files = [{
                    attachment: imageBuffer,
                    name: 'exercise_image.jpg'
                  }];
                }

                await channel.threads.create({
                  name: title,
                  appliedTags: ['1469714038719250462'],
                  message: messagePayload
                });

                console.log('Doodling exercise posted');
                client.destroy();
              });
            } catch (err) {
              console.error('Workflow failed:', err);
              process.exit(1);
            }
          }

          run();
          "
