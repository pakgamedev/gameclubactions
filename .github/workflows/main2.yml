name: Pick Random Weekly Game

on:
  schedule:
    # 7:00 AM PKT is 02:00 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:

jobs:
  pick-game:
    runs-on: ubuntu-latest
    permissions:
          # Give the default GITHUB_TOKEN write permission to commit and push the
          # added or changed files to the repository.
          contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install firebase-admin discord.js

      - name: Select Game, Post Discord, Generate Reddit Content
        env:
          APP_ID: ${{ vars.APP_ID }}
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          DISCORD_FORUM_CHANNEL_ID: ${{ secrets.DISCORD_FORUM_CHANNEL_ID }}
          DEV_CLUB_ROLE_ID: ${{ secrets.DEV_CLUB_ROLE_ID }}
        run: |
          node <<'EOF'
          const fs = require('fs');
          const admin = require('firebase-admin');
          const { Client, GatewayIntentBits, EmbedBuilder } = require('discord.js');

          admin.initializeApp();
          const db = admin.firestore();

          const client = new Client({ intents: [GatewayIntentBits.Guilds] });

          const {
            APP_ID,
            DISCORD_BOT_TOKEN,
            DISCORD_FORUM_CHANNEL_ID,
            DEV_CLUB_ROLE_ID
          } = process.env;

          async function run() {
            const gamesColPath = `artifacts/${APP_ID}/public/data/games`;
            const currentDocPath = `artifacts/${APP_ID}/public/data/current/game`;

            const snapshot = await db.collection(gamesColPath).get();
            if (snapshot.empty) {
              console.log('No games found');
              return;
            }

            const docs = snapshot.docs;
            const selectedDoc = docs[Math.floor(Math.random() * docs.length)];
            const game = selectedDoc.data();

            await db.doc(currentDocPath).set({
              ...game,
              updated_at: admin.firestore.FieldValue.serverTimestamp()
            });

            await selectedDoc.ref.delete();

            /* ---------- REDDIT CONTENT ---------- */

            const post = {
              title: `We are playing ${game.name} - Weekly Game Dev Club`,
              body: `Game Dev Club is a weekly activity where community is encouraged to try new games, analyze them from a game dev perspective, review them and discuss them on our discord (link in the sidebar)\n\nAs Stephen King says "If you want to be a writer, you must do two things above all others: **read a lot and write a lot**." We have adopted it for our craft and we aim to **Play a lot of games and Make a lot of games.**\n\nThis week we are playing ${game.name}. Everyone have until 11pm Sunday to play, review and discuss the game.`.trim()
            };

            fs.writeFileSync('reddit-auto-post/post.json', JSON.stringify(post, null, 2));

            /* ---------- DISCORD POST ---------- */

            await client.login(DISCORD_BOT_TOKEN);

            client.once('ready', async () => {
              const channel = await client.channels.fetch(DISCORD_FORUM_CHANNEL_ID);

              const now = new Date();
              const sunday = new Date(now);
              const daysUntilSunday = (7 - now.getUTCDay()) % 7;
              sunday.setUTCDate(now.getUTCDate() + daysUntilSunday);
              sunday.setUTCHours(18, 0, 0, 0);
              const unixTimestamp = Math.floor(sunday.getTime() / 1000);

              const embed = new EmbedBuilder()
                .setTitle(`ðŸŽ® Current Game: ${game.name}`)
                .setURL(game.url)
                .setImage(game.header_image)
                .setThumbnail(game.icon_url)
                .addFields({ name: 'Link', value: `[Click here](${game.url})` })
                .setFooter({ text: 'Weekly Game' })
                .setTimestamp();

              await channel.threads.create({
                name: game.name,
                message: {
                  content: `<@&${DEV_CLUB_ROLE_ID}> Download the game and discuss.\nDeadline: <t:${unixTimestamp}:f>`,
                  embeds: [embed]
                }
              });

              client.destroy();
            });
          }

          run().catch(err => {
            console.error(err);
            process.exit(1);
          });
          EOF

      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          file_pattern: 'reddit-auto-post/post.json'
