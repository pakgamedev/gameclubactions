name: Daily Game Theme Exercise

on:
  schedule:
    # Runs at 12:00 PM PKT (07:00 AM UTC) daily
    - cron: '0 7 * * *'
  workflow_dispatch:

jobs:
  post-exercise:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install axios discord.js

      - name: Fetch Word and Post to Discord
        run: |
          node -e "
          const axios = require('axios');
          const { Client, GatewayIntentBits } = require('discord.js');

          async function run() {
            try {
              // 1. Fetch Random Verb
              const wordResponse = await axios.get('https://wordsapiv1.p.rapidapi.com/words/', {
                params: { random: 'true', partOfSpeech: 'verb' },
                headers: {
                  'x-rapidapi-host': 'wordsapiv1.p.rapidapi.com',
                  'x-rapidapi-key': '${{ secrets.RAPIDAPI_KEY }}'
                }
              });

              const { word, results } = wordResponse.data;
              const definitions = results 
                ? results.map(r => \`â€¢ \${r.definition}\`).join('\\n') 
                : 'No definitions found.';

              // 2. Fetch Random Image from Unsplash
              let imageUrl = null;
              try {
                const unsplashRes = await axios.get('https://api.unsplash.com/photos/random', {
                  params: { query: word, orientation: 'landscape', content_filter: 'high' },
                  headers: { 'Authorization': \`Client-ID \${{ secrets.UNSPLASH_ACCESS_KEY }}\` }
                });
                imageUrl = unsplashRes.data.urls.regular + '&.jpg';
              } catch (e) {
                console.log('Unsplash image fetch failed, proceeding without image.');
              }

              // 3. Setup Discord Bot
              const client = new Client({ intents: [GatewayIntentBits.Guilds] });
              await client.login('${{ secrets.DISCORD_BOT_TOKEN }}');

              client.once('ready', async () => {
                const channel = await client.channels.fetch('${{ secrets.DISCORD_TEST_FORUM_CHANNEL_ID }}');
                
                const title = \`Game Theme Exercise | Today's Word '\${word.toUpperCase()}'\`;
                const content = \`You are challenged to come up with one or more game themes about today's word.\\n\\n**\${word.toUpperCase()}**\\n\${definitions}\\n\\nThat's it. Put your answers in the comments below!\\n\\n---\\nCheck https://discord.com/channels/1263723973603102802/1469711211158310992 for details on what counts as a game theme!\`;

                const messagePayload = {
                  content: content
                };

                if (imageUrl) {
                  messagePayload.files = [imageUrl];
                }

                await channel.threads.create({
                  name: title,
                  appliedTags: ['1469713938911461629'],
                  message: messagePayload
                });

                console.log(\`Exercise posted for word: \${word}\`);
                client.destroy();
              });
            } catch (err) {
              console.error('Workflow failed:', err);
              process.exit(1);
            }
          }
          run();
          "