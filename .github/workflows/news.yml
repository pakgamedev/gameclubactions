name: Weekly News Exercise Reminder

on:
  schedule:
    # Runs at 12:00 PM PKT (07:00 AM UTC) every Thursday
    - cron: '0 10 * * 6'
  workflow_dispatch:

jobs:
  post-exercise:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install axios discord.js

      - name: Fetch Trivia and Post to Discord
        run: |
          node -e "
          const axios = require('axios');
          const { Client, GatewayIntentBits } = require('discord.js');

          async function run() {
            try {
              // 1. Setup Discord Bot
              const client = new Client({ intents: [GatewayIntentBits.Guilds] });
              await client.login('${{ secrets.DISCORD_BOT_TOKEN }}');

              client.once('ready', async () => {
                const channel = await client.channels.fetch('${{ secrets.DISCORD_TEST_FORUM_CHANNEL_ID }}');

                const title = \`Reminder: Post a news or movie / tv exercise\`;
                const content =
                  \`Basically the title\\n\\n\`;

                await channel.threads.create({
                  name: title,
                  appliedTags: ['1469714038719250462'],
                  message: {content: content}
                });

                console.log('Reminder posted');
                client.destroy();
              });
            } catch (err) {
              console.error('Workflow failed:', err);
              process.exit(1);
            }
          }

          run();
          "
